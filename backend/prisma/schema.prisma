generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum DocumentStatus {
  UPLOADED
  PROCESSING
  READY
  FAILED
}

enum DocumentAiStatus {
  PENDING
  CATEGORIZING
  READY
  FAILED
}

enum ChatRole {
  USER
  ASSISTANT
}

enum WorkspaceType {
  PERSONAL
  TEAM
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
}

model User {
  id                 String            @id @default(cuid())
  email              String            @unique
  name               String?
  passwordHash       String
  documents          Document[]
  sessions           ChatSession[]
  ownedWorkspaces    Workspace[]       @relation("WorkspaceOwner")
  workspaceMembers   WorkspaceMember[]
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
}

model Workspace {
  id        String            @id @default(cuid())
  name      String
  type      WorkspaceType     @default(PERSONAL)
  ownerId   String
  owner     User              @relation("WorkspaceOwner", fields: [ownerId], references: [id])
  documents Document[]
  categories Category[]
  sessions  ChatSession[]
  members   WorkspaceMember[]
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@index([ownerId])
}

model Category {
  id          String    @id @default(cuid())
  workspaceId String
  name        String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  documents   Document[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
}

model WorkspaceMember {
  id          String        @id @default(cuid())
  workspaceId String
  userId      String
  role        WorkspaceRole @default(MEMBER)
  workspace   Workspace     @relation(fields: [workspaceId], references: [id])
  user        User          @relation(fields: [userId], references: [id])
  createdAt   DateTime      @default(now())

  @@unique([workspaceId, userId])
  @@index([userId])
}

model Document {
  id            String            @id @default(cuid())
  userId        String
  workspaceId   String
  categoryId    String?
  user          User              @relation(fields: [userId], references: [id])
  workspace     Workspace         @relation(fields: [workspaceId], references: [id])
  category      Category?         @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  title         String?
  fileName      String?
  mimeType      String?
  sizeBytes     Int?
  storageKey    String?
  fileUrl       String?
  previewImageUrl String?
  status        DocumentStatus    @default(UPLOADED)
  aiStatus      DocumentAiStatus  @default(PENDING)
  aiConfidence  Float?
  aiMetaJson    String?           @db.LongText
  rawText       String?           @db.LongText
  extractData   Json?
  fields        ExtractedField[]
  citations     ChatCitation[]
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([userId])
  @@index([workspaceId])
}

model ExtractedField {
  id            String   @id @default(cuid())
  documentId    String
  document      Document @relation(fields: [documentId], references: [id])
  key           String
  valueText     String?
  valueNumber   Float?
  valueDate     DateTime?
  confidence    Float?
  sourcePage    Int?
  sourceSnippet String?
  createdAt     DateTime @default(now())

  @@index([documentId])
}

model ChatSession {
  id          String        @id @default(cuid())
  userId      String
  workspaceId String
  user        User          @relation(fields: [userId], references: [id])
  workspace   Workspace     @relation(fields: [workspaceId], references: [id])
  messages    ChatMessage[]
  createdAt   DateTime      @default(now())

  @@index([userId])
  @@index([workspaceId])
}

model ChatMessage {
  id        String    @id @default(cuid())
  sessionId String
  session   ChatSession @relation(fields: [sessionId], references: [id])
  role      ChatRole
  content   String    @db.LongText
  citations ChatCitation[]
  createdAt DateTime  @default(now())

  @@index([sessionId])
}

model ChatCitation {
  id         String   @id @default(cuid())
  messageId  String
  documentId String
  page       Int?
  field      String?
  snippet    String?  @db.LongText
  createdAt  DateTime @default(now())
  message    ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([documentId])
}
